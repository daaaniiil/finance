import{d as j,r as Y,a as X,c as y,o as $,b as A,e as n,w as a,F as Z,f as ee,u as C,g as w,h as te,E as v,i as s,l as ne,m as oe,n as M,p as ae,j as T,t as R,s as le,v as se,x as re,y as ue,z as ie}from"./index-BCHu1gLv.js";import{u as q}from"./index-6hsfsW0q.js";import{H as de}from"./HighChartExpensesIncome-B3dEZ7WD.js";const me={class:"expenses-form"},pe=j({__name:"ExpensesForm",setup(H){const l=q(),b=l.loading,D=Y(),r=X({category:"",amount:null,date:""}),I=y(()=>({category:{required:!0,trigger:"blur",message:"Выберите категорию"},amount:{required:!0,trigger:"blur",message:"Введите сумму"},date:{required:!0,trigger:"blur",message:"Выберите дату"}})),g=y(()=>l.earnings.map(x=>x.month)),d=async()=>{var x,u;if(r.date){const k=new Date(r.date),E=k.getMonth()+1,_=k.getFullYear();r.date=`${_}-${String(E).padStart(2,"0")}-${String(k.getDate()).padStart(2,"0")}`;const V=(x=l.months.find(F=>F.value===E-1))==null?void 0:x.label;if(V&&g.value.includes(V)){const F=l.expenses.filter(e=>{const o=new Date(e.date);return o.getMonth()+1===E&&o.getFullYear()===_}).reduce((e,o)=>e+(o.amount||0),0),t=((u=l.earnings.find(e=>e.month===V))==null?void 0:u.amount)||0;F+Number(r.amount)>t?v.warning("У вас не достаточно средств в выбранном месяце"):r.amount!==null?r.amount<=0?v.warning("Введите положительную сумму"):(await l.createUserDataExpenses(D,r),await l.updateBudget(r.amount,"expenses")):v.warning("Заполните форму")}else v.warning("Вы не получили заработок в этом месяце")}else v.warning("Заполните форму")},L=y(()=>window.innerWidth<378?"top":"left"),U=x=>{const u=new Date;return x.getTime()>u.getTime()},B=["Дом","Образование","Одежда","Авто","Продукты","Транспорт","Здоровье","Красота","Развлечения","Спорт","Перевод","Подписки","Телефон","Коммунальные услуги","Кафе и рестораны","Путешествия и отпуск","Кредитные выплаты","Подарки и благотворительность","Хобби и увлечения","Техника и электроника","Игры и приложения","Ремонт техники и гаджетов","Такси и аренда авто","Семейные мероприятия","Парковка и штрафы","Прочие расходы"];return(x,u)=>{const k=s("el-option"),E=s("el-select"),_=s("el-form-item"),V=s("el-input"),F=s("el-date-picker"),t=s("el-button"),e=s("el-form");return $(),A("div",me,[n(e,{ref_key:"form",ref:D,"label-position":L.value,rules:I.value,model:r,"status-icon":"",disabled:C(b),onSubmit:u[3]||(u[3]=te(()=>{},["prevent"]))},{default:a(()=>[n(_,{label:"Категория",prop:"category"},{default:a(()=>[n(E,{modelValue:r.category,"onUpdate:modelValue":u[0]||(u[0]=o=>r.category=o),placeholder:"Выберите категорию"},{default:a(()=>[($(),A(Z,null,ee(B,(o,i)=>n(k,{key:i,label:o,value:o},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(_,{label:"Сумма",prop:"amount"},{default:a(()=>[n(V,{modelValue:r.amount,"onUpdate:modelValue":u[1]||(u[1]=o=>r.amount=o),type:"number",placeholder:"Введите сумму"},null,8,["modelValue"])]),_:1}),n(_,{label:"Дата",prop:"date"},{default:a(()=>[n(F,{"disabled-date":U,modelValue:r.date,"onUpdate:modelValue":u[2]||(u[2]=o=>r.date=o),placeholder:"Выберите дату"},null,8,["modelValue"])]),_:1}),n(t,{type:"primary",onClick:d,loading:C(b)},{default:a(()=>u[4]||(u[4]=[w("Сохранить")])),_:1},8,["loading"])]),_:1},8,["label-position","rules","model","disabled"])])}}}),ce={class:"income-expenses-page"},ge={class:"income-expenses-page__content"},ve=j({__name:"IncomeExpensesView",setup(H){const l=q(),b=ne(),D=Y(!1),r=t=>new Intl.NumberFormat("ru-RU").format(t),I=t=>new Date(t).toISOString().slice(0,10).split("-").reverse().join("."),g=Y({id:"",amount:null,date:"",category:""}),d=Y(0),L=t=>{g.value={...t},d.value=t.amount,D.value=!0},U=async()=>{var t,e;if(g.value&&d.value&&d.value>0&&g.value.amount!==null)try{if(d.value!==g.value.amount){const i=new Date(g.value.date.split(".").reverse().join(".")).getMonth(),m=(t=l.months.find(p=>p.value===i))==null?void 0:t.label,h=((e=l.earnings.find(p=>p.month===m))==null?void 0:e.amount)||0,N=l.expenses.filter(p=>{const f=new Date(p.date);return f.getMonth()===i&&f.getFullYear()===new Date().getFullYear()}).reduce((p,f)=>p+(f.amount||0),0);if(d.value*=b.getRate,h>d.value+(N-g.value.amount)){await l.updateEarningsExpenses(g.value.id,d.value),d.value/=b.getRate;const p=d.value-g.value.amount,f=p>0?"expenses":"earnings";await l.updateBudget(Math.abs(p),f),D.value=!1,v.success("Сумма успешно обновлена!")}else d.value*=b.getRate,d.value=g.value.amount,v.warning("Ваш расход превышает заработок в выбранном месяце")}else v.warning("Введите новую сумму!")}catch(o){console.error(o)}else v.warning("Введите сумму!")},B=t=>{navigator.clipboard.writeText(`${t.date}: ${t.category} | ${r(t.amount)}${b.getIcon}`),v.success("Скопировано успешно!")},x=async(t,e)=>{await l.deleteExpensesItem(t),await l.updateBudget(e,"earnings")},u=y(()=>l.expenses.slice().sort((t,e)=>{const o=new Date(t.date.replace(/-/g,".")),i=new Date(e.date.replace(/-/g,"."));return o.getTime()-i.getTime()}).reverse().map(t=>({...t,date:I(t.date)}))),k=y(()=>u.value.map(t=>({...t,amount:Math.floor((t.amount??0)/b.getRate)}))),E=y(()=>l.earnings.slice().sort((t,e)=>{const o=l.months.findIndex(m=>m.label===t.month);return l.months.findIndex(m=>m.label===e.month)-o})),_=y(()=>E.value.map(t=>t.month).reverse()),V=y(()=>{const t=l.expenses.reduce((e,o)=>{const i=new Date(o.date).getFullYear(),m=new Date(o.date).toLocaleString("ru-RU",{month:"long"}).toLowerCase();return i===new Date().getFullYear()&&(e[m]=(e[m]||0)+(o.amount||0)),e},{});return _.value.map(e=>t[e.toLowerCase()]||0)}),F=y(()=>E.value.map(t=>{const e=t.month.toLowerCase(),o=l.expenses.filter(i=>{const m=new Date(i.date).getFullYear(),h=new Date(i.date).toLocaleString("ru-RU",{month:"long"}).toLowerCase();if(m===new Date().getFullYear())return h===e}).reduce((i,m)=>i+(m.amount||0),0);return Number(t.amount)-o}).reverse());return oe(async()=>{await l.getUserEarnings(),await l.getUserExpenses(),await l.incomeExpensesEarningsCurrent()}),(t,e)=>{const o=s("el-breadcrumb-item"),i=s("el-breadcrumb"),m=s("el-card"),h=s("el-table-column"),N=s("el-icon"),p=s("el-button"),f=s("el-dropdown-item"),z=s("el-dropdown-menu"),O=s("el-dropdown"),P=s("el-table"),W=s("el-input"),G=s("el-dialog"),J=s("el-empty"),K=s("router-link"),Q=le("loading");return $(),A("div",ce,[n(i,{separator:"/"},{default:a(()=>[n(o,{to:{name:"income-expenses-page"}},{default:a(()=>e[3]||(e[3]=[w("Доходы & Расходы")])),_:1}),n(o,null,{default:a(()=>e[4]||(e[4]=[w("Аналитика")])),_:1})]),_:1}),M("div",ge,[n(m,null,{default:a(()=>[e[5]||(e[5]=M("h2",null,"Добавить расход",-1)),n(pe)]),_:1}),n(m,null,{default:a(()=>[e[11]||(e[11]=M("h2",null,"Ваши расходы",-1)),ae(($(),T(P,{data:k.value,"max-height":500},{default:a(()=>[n(h,{fixed:"",prop:"date",label:"Дата",width:"120"}),n(h,{prop:"category",label:"Категория",width:"300"}),n(h,{prop:"amount",label:"Сумма",align:"center","min-width":"120"},{default:a(c=>[M("span",null,R(r(c.row.amount))+R(C(b).getIcon),1)]),_:1}),n(h,{align:"center",label:"Действия",width:"130"},{default:a(c=>[n(O,{trigger:"click"},{dropdown:a(()=>[n(z,{slot:"dropdown"},{default:a(()=>[n(f,{icon:C(se),disabled:Number(c.row.date.slice(6,10))!==new Date().getFullYear(),onClick:S=>L(c.row)},{default:a(()=>e[8]||(e[8]=[w("Edit")])),_:2},1032,["icon","disabled","onClick"]),n(f,{icon:C(re),onClick:S=>B(c.row)},{default:a(()=>e[9]||(e[9]=[w("Copy")])),_:2},1032,["icon","onClick"]),n(f,{icon:C(ue),disabled:Number(c.row.date.slice(6,10))!==new Date().getFullYear(),onClick:S=>x(c.row.id,c.row.amount),style:{color:"red"}},{default:a(()=>e[10]||(e[10]=[w("Delete ")])),_:2},1032,["icon","disabled","onClick"])]),_:2},1024)]),default:a(()=>[n(p,{class:"el-dropdown-link"},{default:a(()=>[n(N,null,{default:a(()=>[n(C(ie))]),_:1}),e[6]||(e[6]=w()),e[7]||(e[7]=M("i",{class:"el-icon-arrow-down el-icon--right"},null,-1))]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Q,C(l).loading]])]),_:1}),n(G,{title:"Редактировать расход",modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=c=>D.value=c),width:"30%"},{footer:a(()=>[n(p,{type:"warning",onClick:e[1]||(e[1]=c=>D.value=!1)},{default:a(()=>e[12]||(e[12]=[w("Отменить")])),_:1}),n(p,{type:"primary",onClick:U},{default:a(()=>e[13]||(e[13]=[w("Сохранить")])),_:1})]),default:a(()=>{var c;return[M("p",null,"Измените сумму для расхода: "+R((c=g.value)==null?void 0:c.category),1),n(W,{type:"number",modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=S=>d.value=S),modelModifiers:{number:!0},placeholder:"Введите новую сумму"},null,8,["modelValue"])]}),_:1},8,["modelValue"]),_.value.length===0?($(),T(J,{key:0,description:"Вы еще не добавили расходы или заработок в текущем году"})):($(),T(de,{key:1,months:_.value,expenses:V.value,income:F.value,title:`Доходы и расходы ${new Date().getFullYear()}`},null,8,["months","expenses","income","title"]))]),n(K,{to:{name:"analytics-page"}},{default:a(()=>[n(p,{type:"primary"},{default:a(()=>e[14]||(e[14]=[w("Детальная аналитика")])),_:1})]),_:1})])}}});export{ve as default};
