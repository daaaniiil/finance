import{G as de,r as f,H as ge,l as me,a as ve,I as i,E as y}from"./index-DROb3nJz.js";const Re=de("finance",()=>{const p=f(0),g=f(null),D=f([]),z=f([]),v=f([]),U=f([]),q=JSON.parse(localStorage.getItem("hiddenGoals")||"[]"),B=f([]),P=f([]),F=f([]),N=f([]),R=f([]),x=f([]),G=f(0),J=f("Нету"),L=f(0),T=f("Нету"),H=f(0),K=f(0),Q=f(0),O=f(0),C=f(0),I=f(0),k=f(0),b=[{label:"Январь",value:0},{label:"Февраль",value:1},{label:"Март",value:2},{label:"Апрель",value:3},{label:"Май",value:4},{label:"Июнь",value:5},{label:"Июль",value:6},{label:"Август",value:7},{label:"Сентябрь",value:8},{label:"Октябрь",value:9},{label:"Ноябрь",value:10},{label:"Декабрь",value:11}],W=new Date().getFullYear(),o=f(!1),X=ge(),d=me(),c=ve({goals:!1,earnings:!1,lastYearEarnings:!1,expenses:!1,user:!1,budget:!1,earningsBackup:!1}),h=async()=>{if(!c.user)try{const{data:e,error:r}=await i.auth.getUser();r||!e?console.error((r==null?void 0:r.message)||"Пользователь не авторизован"):(g.value=e.user||[],c.user=!0)}catch(e){console.error(e)}},$=async()=>{var e;if(!c.earnings){o.value=!0;try{await h();const{data:r,error:n}=await i.from("earnings").select("id, month, amount").eq("user_id",(e=g.value)==null?void 0:e.id);n?console.error(`${n.message}`):(D.value=r||[],c.earnings=!0)}catch(r){console.error("Ошибка при получение данных",r)}finally{o.value=!1}}},Z=async(e,r)=>{if(!e.value){console.error("Add earnings form not found");return}e.value.validate(async n=>{var a,t;if(n){o.value=!0;try{await h(),r.amount!==null&&(r.amount*=d.getRate);const{error:s}=await i.from("earnings").insert([{user_id:(a=g.value)==null?void 0:a.id,month:r.month,amount:r.amount}]),l=(t=b.find(u=>u.label===r.month))==null?void 0:t.value;s?y.error(`${s.message}`):(y.success("Заработок успешно добавлен!"),c.earnings=!1,await $(),l===new Date().getMonth()-1&&await j(),r.amount=null,r.month="")}catch(s){console.error("Ошибка при добавление данных",s)}finally{o.value=!1}}else console.error("Form validation failed"),o.value=!1})},ee=async(e,r)=>{var n;o.value=!0;try{const a=(n=b.find(s=>s.label===r))==null?void 0:n.value;if(v.value.filter(s=>Number(s.date.slice(5,7))-1===a&&Number(s.date.slice(0,4))===new Date().getFullYear()).length)y.warning("У вас в этом месяце есть расходы, вы не можете его удалить");else{const{data:s,error:l,status:u}=await i.from("earnings").delete().eq("id",e);l?console.error("Error deleting item:",l):u===204?(c.earnings=!1,await $(),y.success("Удалено успешно!")):console.log("Unexpected response:",s)}}catch(a){console.error("Error during delete:",a)}finally{o.value=!1}},ae=async(e,r,n)=>{var a;o.value=!0;try{const t=(a=b.find(l=>l.label===n))==null?void 0:a.value,{error:s}=await i.from("earnings").update({amount:r}).eq("id",e);s?console.error("Ошибка обновления суммы:",s):(c.earnings=!1,await $(),t===new Date().getMonth()-1&&await j())}catch(t){console.error(t)}finally{o.value=!1}},S=async()=>{var e;if(!c.expenses){o.value=!0;try{await h();const{data:r,error:n}=await i.from("expenses").select("*").eq("user_id",(e=g.value)==null?void 0:e.id);n?console.error(`${n.message}`):(v.value=r||[],c.expenses=!0)}catch(r){console.error(r)}finally{o.value=!1}}},te=async(e,r)=>{if(!e.value){console.error("Expenses form not found");return}e.value.validate(async n=>{var a;if(n)try{await h(),r.amount!==null&&(r.amount*=d.getRate);const{error:t}=await i.from("expenses").insert([{user_id:(a=g.value)==null?void 0:a.id,category:r.category,amount:r.amount,date:r.date}]);t&&y.error(`${t.message}`),y.success("Расход успешно добавлен!"),c.expenses=!1,await S(),r.amount=null,r.category="",r.date=""}catch(t){console.error(t)}finally{o.value=!1}else console.error("Form validation failed"),o.value=!1})},re=async(e,r)=>{o.value=!0;try{const{error:n}=await i.from("expenses").update({amount:r}).eq("id",e);n&&console.error("Ошибка обновления суммы:",n),c.expenses=!1,await S()}catch(n){console.error(n)}finally{o.value=!1}},ne=async e=>{o.value=!0;try{const{data:r,error:n,status:a}=await i.from("expenses").delete().eq("id",e);n?console.error("Error deleting expenses:",n):a===204?(y.success("Удалено успешно!"),c.expenses=!1,await S()):console.log("Unexpected response:",r)}catch(r){console.error(r)}finally{o.value=!1}},se=async()=>{var e;if(!c.lastYearEarnings){o.value=!0;try{await h();const{data:r,error:n}=await i.from("last-year-earnings").select("id, month, amount, year").eq("user_id",(e=g.value)==null?void 0:e.id);n?console.error(`${n.message}`):(z.value=r||[],c.lastYearEarnings=!0)}catch(r){console.error(r)}finally{o.value=!1}}},Y=async()=>{var e;if(!c.goals){o.value=!0;try{await h();const{data:r,error:n}=await i.from("goals").select("*").eq("user_id",(e=g.value)==null?void 0:e.id);n?console.error(`${n.message}`):(U.value=r||[],c.goals=!0)}catch(r){console.error(r)}finally{o.value=!1}}},oe=async(e,r)=>{if(!e.value){console.error("Add goal form not found"),y.success("Заполните форму");return}e.value.validate(async n=>{var a;if(n)try{await Y(),r.targetAmount*=d.getRate;const t=new Date(r.deadline),s=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,{error:l}=await i.from("goals").insert([{user_id:(a=g.value)==null?void 0:a.id,name:r.name,targetAmount:r.targetAmount,currentAmount:0,status:"in_progress",deadline:s}]);l&&y.error(`${l.message}`),y.success("Цель успешно добавлена!"),c.goals=!1,await Y(),r.name="",r.targetAmount=0}catch(t){console.error(t)}finally{o.value=!1}else console.error("Form validation failed"),o.value=!1})},le=async(e,r,n)=>{o.value=!0;try{const{data:a,error:t}=await i.from("goals").select("currentAmount").eq("id",e).single();if(t){console.error("Ошибка получения текущей суммы цели:",t);return}const s=(a.currentAmount||0)+Number(r.toFixed()),{error:l}=await i.from("goals").update({currentAmount:s,status:n}).eq("id",e);l&&console.error("Ошибка обновления цели:",l),c.goals=!1,await Y()}catch(a){console.error(a)}finally{o.value=!1}},ue=async e=>{o.value=!0;try{const{data:r,error:n,status:a}=await i.from("goals").delete().eq("id",e);n?console.error("Error deleting goal:",n):a===204?(y.success("Цель удалена!"),c.goals=!1,await Y()):console.log("Unexpected response:",r)}catch(r){console.error(r)}finally{o.value=!1}},ce=e=>{q.includes(e)||(q.push(e),localStorage.setItem("hiddenGoals",JSON.stringify(q)),c.goals=!1)},ie=async()=>{o.value=!0;try{await S();const e=t=>{const s={};return t.forEach(l=>{l.name!==null&&(s[l.name]?s[l.name]+=l.y:s[l.name]=l.y)}),Object.keys(s).map(l=>({name:l,y:s[l]}))},r=v.value.filter(t=>Number(t.date.slice(0,4))===new Date().getFullYear()).map(t=>({name:t.category,date:t.date,y:Math.ceil((t.amount??0)/d.getRate)})),n=D.value.map(t=>({name:t.month,y:Math.ceil((t.amount??0)/d.getRate)})),a=v.value.filter(t=>Number(t.date.slice(5,7))===new Date().getMonth()+1&&Number(t.date.slice(0,4))===new Date().getFullYear()).map(t=>({name:t.category,date:t.date,y:Math.ceil((t.amount??0)/d.getRate)}));B.value=e(r),P.value=e(n),F.value=e(a)}catch(e){console.error(e)}finally{o.value=!1}},fe=async()=>{o.value=!0;try{const e=new Date().toISOString().split("T")[0],r=U.value.map(async n=>{let a=n.status,t=n.deadline;n.currentAmount>=n.targetAmount&&a!=="completed"&&(a="completed",t=e),new Date(n.deadline)<=new Date(e)&&a!=="completed"&&(a="failed"),a!==n.status&&await i.from("goals").update({status:a,deadline:t}).eq("id",n.id)});await Promise.all(r),c.goals=!1,await Y()}catch(e){console.error(e)}finally{o.value=!1}},j=async()=>{var e,r;o.value=!0;try{await h();const n=new Date().toLocaleDateString().slice(3,5);let a=new Date().getMonth();a===0&&(a=12);const t=(e=b.find(u=>u.value===a-1))==null?void 0:e.label,s=D.value.find(u=>u.month===t);if(s)C.value=(s==null?void 0:s.amount)||0;else{if(c.earningsBackup)return;const{data:u,error:w}=await i.from("earnings_backup").select("amount, user_id").eq("user_id",(r=g.value)==null?void 0:r.id).eq("month",t).eq("year",new Date().getFullYear()-1);w&&console.error(`Ошибка при получение данных из earnings_backup: ${w.message}`);const m=(u||[]).find(M=>{var _;return M.user_id===((_=g.value)==null?void 0:_.id)});C.value=(m==null?void 0:m.amount)||0,c.earningsBackup=!0}C.value/=d.getRate;let l=v.value.filter(u=>Number(u.date.slice(5,7))===a&&Number(u.date.slice(0,4))===new Date().getFullYear()).map(u=>u.amount).filter(u=>u!==null);!l.length&&n==="01"&&(l=v.value.filter(u=>Number(u.date.slice(5,7))===a&&Number(u.date.slice(0,4))===new Date().getFullYear()-1).map(u=>u.amount).filter(u=>u!==null)),O.value=l.reduce((u,w)=>u+w)||0,O.value/=d.getRate}catch(n){console.error(n)}finally{o.value=!1}};return{budget:p,amountExpenses:H,isLoader:c,user:g,loading:o,earnings:D,expenses:v,goals:U,yearNow:W,months:b,expensesLastMonthAmount:O,earningsLastMonthAmount:C,earningsCurrentMonthAmount:I,expensesCurrentMonthAmount:k,mergedExpenses:B,minExpenses:G,minExpensesCategories:J,maxExpenses:L,maxExpensesCategories:T,averageExpenses:Q,expensesDaysCurrentMonth:N,expensesTenCategoryCurrentMonth:R,expensesDaysLastMonth:x,hiddenGoals:q,lastYearEarnings:z,amountEarnings:K,expensesDaysMonthLast:async()=>{o.value=!0;try{const e=new Date().toLocaleDateString().slice(3,5);let r=new Date().getMonth();r===0&&(r=12),x.value=v.value.filter(a=>Number(a.date.slice(5,7))===r&&Number(a.date.slice(0,4))===new Date().getFullYear()).sort(function(a,t){return a.date>t.date?1:a.date<t.date?-1:0}).map(a=>({amount:Math.floor((a.amount??0)/d.getRate),date:a.date.slice(8,10)})),!x.value.length&&e==="01"&&(x.value=v.value.filter(a=>Number(a.date.slice(5,7))===r&&Number(a.date.slice(0,4))===new Date().getFullYear()-1).sort(function(a,t){return a.date>t.date?1:a.date<t.date?-1:0}).map(a=>({amount:Math.floor((a.amount??0)/d.getRate),date:a.date.slice(8,10)})));const n=a=>{const t={};return a.forEach(s=>{s.amount!==null&&(t[s.date]?t[s.date]+=s.amount:t[s.date]=s.amount)}),Object.keys(t).map(s=>({date:s,amount:t[s]}))};x.value=n(x.value),x.value.sort(function(a,t){return a.date>t.date?1:a.date<t.date?-1:0})}catch(e){console.error(e)}finally{o.value=!1}},expensesDaysMonthCurrent:async()=>{o.value=!0;try{N.value=v.value.filter(n=>Number(n.date.slice(5,7))===new Date().getMonth()+1&&Number(n.date.slice(0,4))===new Date().getFullYear()).sort(function(n,a){return n.date>a.date?1:n.date<a.date?-1:0}).map(n=>({amount:Math.floor((n.amount??0)/d.getRate),date:n.date.slice(8,10)})),R.value=v.value.filter(n=>Number(n.date.slice(5,7))===new Date().getMonth()+1&&Number(n.date.slice(0,4))===new Date().getFullYear()).map(n=>({amount:Math.floor((n.amount??0)/d.getRate),category:n.category}));const e=n=>{const a={};return n.forEach(t=>{t.amount!==null&&(a[t.date]?a[t.date]+=t.amount:a[t.date]=t.amount)}),Object.keys(a).map(t=>({date:t,amount:a[t]}))},r=n=>{const a={};return n.forEach(t=>{t.amount!==null&&(a[t.category]?a[t.category]+=t.amount:a[t.category]=t.amount)}),Object.keys(a).map(t=>({category:t,amount:a[t]}))};N.value=e(N.value),N.value.sort(function(n,a){return n.date>a.date?1:n.date<a.date?-1:0}),R.value=r(R.value),R.value.sort(function(n,a){return n.amount<a.amount?1:n.amount>a.amount?-1:0})}catch(e){console.error(e)}finally{o.value=!1}},minMaxExpensesAmount:async()=>{var e,r;o.value=!0;try{const n=F.value.map(t=>t.y);G.value=n.reduce((t,s)=>Math.min(t,s)),J.value=(e=F.value.find(t=>t.y===G.value))==null?void 0:e.name,L.value=Math.max(...n),T.value=(r=F.value.find(t=>t.y===L.value))==null?void 0:r.name;const a=new Date().getDate();Q.value=k.value/a}catch(n){console.error(n)}finally{o.value=!1}},amountExpensesEarningsCategories:async()=>{o.value=!0;try{H.value=B.value.map(e=>e.y).filter(e=>e!==void 0).reduce((e,r)=>e+r),K.value=P.value.map(e=>e.y).filter(e=>e!==void 0).reduce((e,r)=>e+r)}catch(e){console.error(e)}finally{o.value=!1}},authUser:h,getUserEarnings:$,createUserDataEarnings:Z,deleteEarningsItemData:ee,updateEarningsAmount:ae,getUserExpenses:S,deleteExpensesItem:ne,updateEarningsExpenses:re,createUserDataExpenses:te,getUserGoals:Y,createUserGoal:oe,updateUserGoal:le,updateGoalStatus:fe,logout:async()=>{o.value=!0;try{const{error:e}=await i.auth.signOut();e?console.error(e):(await X.push({name:"login-page"}),y.success("Вы вышли из аккаунта!"))}catch(e){console.error(e)}finally{o.value=!1}},nowNewYear:async()=>{var e,r,n;o.value=!0;try{await h(),await $();const a=new Date().getFullYear(),t=localStorage.getItem("lastRunYear");if(t===String(a)||t===null){localStorage.setItem("lastRunYear",String(a));return}const{data:s,error:l}=await i.from("earnings").select("*");if(l&&console.error(`Ошибка при получение данных из earnings: ${l.message}`),!s||s.length===0)return;const u=a-1,w=new Date().getMonth()===0?12:new Date().getMonth(),A=(e=b.find(E=>E.value===w-1))==null?void 0:e.label,m=D.value.find(E=>E.month===A);if(m){const{error:E}=await i.from("earnings_backup").insert({user_id:(r=g.value)==null?void 0:r.id,month:m.month,amount:m.amount,year:u});E&&console.error(`Ошибка при сохранении зарплаты за прошлый месяц: ${E.message}`)}const M=s.map(E=>({...E,year:u})),{error:_}=await i.from("last-year-earnings").insert(M);_&&console.error(`Ошибка при переносе данных: ${_.message}`);const{error:V}=await i.from("earnings").delete().eq("user_id",(n=g.value)==null?void 0:n.id);V&&console.error(`Ошибка при очистке таблицы earnings: ${V.message}`)}catch(a){console.error(a)}finally{o.value=!1}},incomeExpensesEarnings:j,incomeExpensesEarningsCurrent:async()=>{var e,r;o.value=!0;try{const n=new Date().getMonth(),a=(e=b.find(s=>s.value===n))==null?void 0:e.label;I.value=((r=D.value.find(s=>s.month===a))==null?void 0:r.amount)||0,I.value/=d.getRate;const t=v.value.filter(s=>Number(s.date.slice(5,7))===n+1&&Number(s.date.slice(0,4))===new Date().getFullYear()).map(s=>s.amount).filter(s=>s!==null);k.value=t.reduce((s,l)=>s+l)||0,k.value/=d.getRate}catch(n){console.error(n)}finally{o.value=!1}},expensesEarningsCategories:ie,fetchBudget:async()=>{var e;if(!c.budget){o.value=!0;try{const{data:r,error:n}=await i.from("budget").select("budget").eq("user_id",(e=g.value)==null?void 0:e.id).single();n&&console.error(`Error get budget: ${n.message}`),p.value=(r==null?void 0:r.budget)||0,p.value/=d.getRate,c.budget=!0}catch(r){console.error(`Error get budget: ${r}`)}finally{o.value=!1}}},initializeBudget:async()=>{var e,r,n;o.value=!0;try{const{data:a,error:t}=await i.from("earnings").select("amount").eq("user_id",(e=g.value)==null?void 0:e.id);t&&console.error(`Error initializeBudget: ${t.message}`);const s=(a??[]).reduce((m,M)=>m+M.amount,0),{data:l,error:u}=await i.from("expenses").select("amount, date").eq("user_id",(r=g.value)==null?void 0:r.id);u&&console.error(`Error initializeBudget: ${u.message}`);const w=(l??[]).filter(m=>Number(m.date.slice(0,4))===new Date().getFullYear()).reduce((m,M)=>m+M.amount,0);p.value=s-w,p.value/=d.getRate,c.budget=!0;const{error:A}=await i.from("budget").insert({user_id:(n=g.value)==null?void 0:n.id,budget:p.value});A&&console.error(`Ошибка при инициализации бюджета: ${A}`)}catch(a){console.error(`Ошибка при инициализации бюджета: ${a}`)}finally{o.value=!1}},updateBudget:async(e,r)=>{var n;o.value=!0;try{e*=d.getRate;const a=r==="earnings"?e:-e;p.value*=d.getRate,p.value+=a;const{error:t}=await i.from("budget").update({budget:p.value}).eq("user_id",(n=g.value)==null?void 0:n.id);p.value/=d.getRate,t&&console.error(`Ошибка при обновление бюджета: ${t.message}`)}catch(a){console.error(`Ошибка при обновление бюджета: ${a}`)}finally{o.value=!1}},hideGoal:ce,deleteGoal:ue,getLastYearEarnings:se}});export{Re as u};
